<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Orchestral - Consultation Request</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <nav class="navbar">
    <div class="nav-brand">ðŸŽ¼ Orchestral</div>
    <div class="nav-links">
      <a href="/">Dashboard</a>
      <a href="/settings">Settings</a>
      <a href="/history">History</a>
    </div>
  </nav>

  <main class="container">
    <section>
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2>Consultation Request</h2>
        <span id="crp-id" class="mono" style="color: var(--text-muted);"></span>
      </div>

      <div style="margin-bottom: 1rem;">
        <span style="color: var(--text-muted);">From:</span>
        <span id="crp-from" style="color: var(--accent-blue);"></span>
      </div>

      <div class="mrp-summary" style="margin-bottom: 1.5rem;">
        <div id="single-question-view">
          <h3 style="margin-bottom: 0.5rem;">Question</h3>
          <p id="crp-question" style="font-size: 1.1rem; margin-bottom: 1rem;"></p>
          <h4 style="color: var(--text-muted); margin-bottom: 0.5rem;">Context</h4>
          <p id="crp-context" style="color: var(--text-secondary);"></p>
        </div>
        <div id="multi-question-view" style="display: none;">
          <h3 style="margin-bottom: 0.5rem;">Context</h3>
          <p id="crp-context-multi" style="color: var(--text-secondary); margin-bottom: 1rem;"></p>
        </div>
      </div>

      <form id="crp-form">
        <div id="questions-container">
          <!-- Questions with options will be populated here -->
        </div>

        <div class="form-group">
          <label for="rationale">Rationale (optional)</label>
          <textarea
            id="rationale"
            name="rationale"
            rows="3"
            placeholder="Explain your reasoning..."
          ></textarea>
        </div>

        <div class="form-group">
          <label for="additional-notes">Additional Notes (optional)</label>
          <textarea
            id="additional-notes"
            name="additional-notes"
            rows="2"
            placeholder="Any additional context or constraints..."
          ></textarea>
        </div>

        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="applies-to-future" name="applies-to-future">
            <label for="applies-to-future">Apply this decision to similar future cases</label>
          </div>
        </div>

        <div class="form-actions" style="display: flex; gap: 0.5rem;">
          <button type="submit" class="btn btn-primary">Submit Decision</button>
          <a id="back-link" href="/" class="btn btn-secondary">Cancel</a>
        </div>
      </form>
    </section>
  </main>

  <script>
    const pathParts = window.location.pathname.split('/');
    const runId = pathParts[2];
    const crpId = pathParts[4];

    let selectedOptions = {}; // { questionId: optionId }
    let isMultiQuestion = false;

    async function loadCRP() {
      const res = await fetch(`/api/crp/${runId}/${crpId}`);
      const data = await res.json();

      if (!data.success) {
        alert('CRP not found');
        window.location.href = `/run/${runId}`;
        return;
      }

      const crp = data.data;

      document.getElementById('crp-id').textContent = crp.crp_id;
      document.getElementById('crp-from').textContent = crp.created_by.charAt(0).toUpperCase() + crp.created_by.slice(1);
      document.getElementById('back-link').href = `/run/${runId}`;

      const container = document.getElementById('questions-container');

      // Check if CRP uses questions array (multi-question) or single question format
      if (crp.questions && Array.isArray(crp.questions)) {
        isMultiQuestion = true;
        document.getElementById('single-question-view').style.display = 'none';
        document.getElementById('multi-question-view').style.display = 'block';

        if (crp.context) {
          document.getElementById('crp-context-multi').textContent = crp.context;
        }

        // Render each question with its options
        container.innerHTML = crp.questions.map((q, idx) => `
          <div class="form-group question-block" data-question-id="${q.id}">
            <h4 style="margin-bottom: 0.5rem; color: var(--accent-blue);">Q${idx + 1}: ${q.question}</h4>
            ${q.context ? `<p style="color: var(--text-muted); margin-bottom: 0.75rem; font-size: 0.9rem;">${q.context}</p>` : ''}
            <div class="options-list">
              ${(q.options || []).map(opt => `
                <label class="option-card" data-question="${q.id}" data-option="${opt.id}">
                  <input type="radio" name="decision-${q.id}" value="${opt.id}">
                  <div class="option-header">
                    <span class="option-id">${opt.id}</span>
                    <span class="option-label">${opt.label}</span>
                    ${q.recommendation === opt.id ? '<span class="option-recommended">Recommended</span>' : ''}
                  </div>
                  <div class="option-description">${opt.description}</div>
                  ${opt.risk ? `<div class="option-risk">Risk: ${opt.risk}</div>` : ''}
                </label>
              `).join('')}
            </div>
          </div>
        `).join('');

      } else {
        // Single question format (legacy)
        isMultiQuestion = false;
        document.getElementById('single-question-view').style.display = 'block';
        document.getElementById('multi-question-view').style.display = 'none';
        document.getElementById('crp-question').textContent = crp.question || '';
        document.getElementById('crp-context').textContent = crp.context || '';

        container.innerHTML = `
          <div class="form-group">
            <label>Options</label>
            <div class="options-list" id="options-list">
              ${(crp.options || []).map(opt => `
                <label class="option-card" data-question="single" data-option="${opt.id}">
                  <input type="radio" name="decision-single" value="${opt.id}">
                  <div class="option-header">
                    <span class="option-id">${opt.id}</span>
                    <span class="option-label">${opt.label}</span>
                    ${crp.recommendation === opt.id ? '<span class="option-recommended">Recommended</span>' : ''}
                  </div>
                  <div class="option-description">${opt.description}</div>
                  ${opt.risk ? `<div class="option-risk">Risk: ${opt.risk}</div>` : ''}
                </label>
              `).join('')}
            </div>
          </div>
        `;
      }

      // Add click handlers for all option cards
      document.querySelectorAll('.option-card').forEach(card => {
        card.addEventListener('click', () => {
          const questionId = card.dataset.question;
          // Deselect other options in the same question
          document.querySelectorAll(`.option-card[data-question="${questionId}"]`).forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          card.querySelector('input').checked = true;
          selectedOptions[questionId] = card.dataset.option;
        });
      });
    }

    document.getElementById('crp-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      // Validate that all questions have been answered
      const questionBlocks = document.querySelectorAll('.question-block');
      const requiredQuestions = isMultiQuestion ? questionBlocks.length : 1;
      const answeredQuestions = Object.keys(selectedOptions).length;

      if (answeredQuestions === 0) {
        alert('Please select an option');
        return;
      }

      if (isMultiQuestion && answeredQuestions < requiredQuestions) {
        alert(`Please answer all questions (${answeredQuestions}/${requiredQuestions} answered)`);
        return;
      }

      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';

      try {
        // Format decisions based on single or multi-question mode
        const decisions = isMultiQuestion ? selectedOptions : selectedOptions['single'];

        const res = await fetch(`/api/crp/${runId}/${crpId}/respond`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            decision: decisions,
            decisions: isMultiQuestion ? selectedOptions : undefined,
            rationale: document.getElementById('rationale').value,
            additionalNotes: document.getElementById('additional-notes').value,
            appliesToFuture: document.getElementById('applies-to-future').checked
          })
        });

        const data = await res.json();

        if (data.success) {
          window.location.href = `/run/${runId}`;
        } else {
          alert('Failed to submit: ' + data.error);
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit Decision';
        }
      } catch (error) {
        alert('Error: ' + error.message);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Decision';
      }
    });

    loadCRP();
  </script>
</body>
</html>
